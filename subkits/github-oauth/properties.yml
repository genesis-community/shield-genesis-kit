---
instance_groups:
  - name: shield
    jobs:
    - name: postgres
      properties:
        databases:
        - name: sessions
          citext: true
        roles:
        - name: oauth
          password: (( vault meta.vault "/database/sessions:password" ))

    - name: shield-daemon
      properties:
        auth:
          oauth:
            provider: github
            key:      (( vault meta.vault "/oauth:provider_key" ))
            secret:   (( vault meta.vault "/oauth:provider_secret" ))
            authorization:
              orgs:   (( grab params.authz_allowed_orgs ))
            sessions:
              db:
                name:     sessions
                host:     (( grab instance_groups.shield.jobs.shield-daemon.properties.database.host ))
                port:     (( grab instance_groups.shield.jobs.shield-daemon.properties.database.port ))
                password: (( grab instance_groups.shield.jobs.shield-daemon.properties.database.password ))
                username: (( grab instance_groups.shield.jobs.shield-daemon.properties.database.username ))

